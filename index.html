â¤ï¸Made By Daniel TaoğŸ¤ª
<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" 
	  content="width=device-width, 
			   initial-scale=1.0, 
			   maximum-scale=1.0, 
			   user-scalable=no,
			   shrink-to-fit=no">
	<title>RPG World</title>
	<style>
	
	.drop-notice {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 15px 30px;
  border-radius: 10px;
  font-size: 24px;
  animation: dropFloat 1.5s ease-out forwards;
  pointer-events: none;
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 10px;
}
@keyframes dropFloat {
  0% { opacity: 1; transform: translate(-50%, -40%); }
  100% { opacity: 0; transform: translate(-50%, -100%); }
}
	
	/* æ–°å¢ä¼¤å®³æ•°å­—åŠ¨ç”» */
.damage-number {
  position: absolute;
  color: #ff4444;
  font-weight: bold;
  font-size: 24px;
  animation: floatUp 1s ease-out forwards;
  pointer-events: none;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

@keyframes floatUp {
  0% { transform: translateY(0); opacity: 1; }
  100% { transform: translateY(-50px); opacity: 0; }
}

/* æ–°å¢è¡€æ¡æŠ–åŠ¨åŠ¨ç”» */
@keyframes shake {
  0% { transform: translateX(0); }
  25% { transform: translateX(5px); }
  50% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
  100% { transform: translateX(0); }
}

.shake {
  animation: shake 0.3s ease-in-out;
}
	
/* æ–°å¢é˜²æ­¢ç¼©æ”¾æ ·å¼ */
html {
  touch-action: manipulation;
  overflow-anchor: none;
}
		body { 
			font-family: Arial; 
			margin: 0;
			padding: 10px;
			background: #f0f0f0;
		}
		.login-box {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: white;
			padding: 20px;
			border-radius: 10px;
			box-shadow: 0 0 10px rgba(0,0,0,0.2);
			z-index: 999;
		}
		.hidden { display: none; }
		.status-box {
			background: white;
			padding: 15px;
			border-radius: 10px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
			margin-bottom: 10px;
		}
		.button-group {
			display: flex;
			gap: 10px;
			margin: 10px 0;
		}
		button {
			flex: 1;
			padding: 12px;
			border: none;
			border-radius: 8px;
			color: white;
			font-size: 16px;
		}
		.backpack {
			background: white;
			border-radius: 10px;
			padding: 15px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
		}
		.equipment-item {
			padding: 10px;
			margin: 5px 0;
			border-radius: 5px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

/* ä¿®æ”¹åçš„åŠ¨æ€é¢œè‰²æ ·å¼ */
.white { 
	background: #ffffff; 
	border: 1px solid #e0e0e0;
}
/* ç»¿è‰²ï¼šå¢åŠ é¢œè‰²å¯¹æ¯”åº¦ */
.green {
	background: linear-gradient(90deg, 
		#f1f8e9,  /* æ›´æ·¡çš„ç»¿è‰² */
		#c8e6c9 70%, 
		#81c784); /* æ›´æ·±çš„ç»¿è‰² */
	background-size: 300% 100%;
	animation: gradientAnimation 6s linear infinite;
}

/* è“è‰²ï¼šå¢åŠ æ¸å˜è·¨åº¦ */
.blue {
	background: linear-gradient(90deg, 
		#e1f5fe,  /* å†°è“è‰² */
		#81d4fa 50%, 
		#039be5); /* æ·±è“è‰² */
	background-size: 300% 100%;
	animation: gradientAnimation 5s ease-in-out infinite;
}

/* ç´«è‰²ï¼šæ·»åŠ ä¸­é—´è¿‡æ¸¡è‰² */
.purple {
	background: linear-gradient(90deg, 
		#f3e5f5, 
		#ce93d8 40%, 
		#8e24aa); /* æ·±ç´«è‰² */
	background-size: 300% 100%;
	animation: gradientAnimation 5s ease infinite;
}

/* é»„è‰²ï¼šå¢åŠ é¥±å’Œåº¦å˜åŒ– */
.yellow {
	background: linear-gradient(90deg, 
		#fffde7, 
		#fff176 60%, 
		#fdd835); /* äº®é»„è‰² */
	background-size: 300% 100%;
	animation: gradientAnimation 5s linear infinite;
}

/* æ©™è‰²ï¼šå¢å¼ºæ˜æš—å¯¹æ¯” */
.orange {
	background: linear-gradient(90deg, 
		#fff3e0, 
		#ffb74d 50%, 
		#f57c00); /* æ·±æ©™è‰² */
	background-size: 300% 100%;
	animation: gradientAnimation 3s ease-in-out infinite;
}

/* çº¢è‰²ï¼šå¢åŠ æ·±çº¢è‰²ç»ˆç‚¹ */
.red {
	background: linear-gradient(90deg, 
		#ffebee, 
		#ef9a9a 50%, 
		#d32f2f); /* æ·±çº¢è‰² */
	background-size: 300% 100%;
	animation: gradientAnimation 3s linear infinite;
}

/* ç²‰è‰²ï¼šæ·»åŠ æ¸å˜å±‚æ¬¡ */
.pink {
	background: linear-gradient(90deg, 
		#fce4ec, 
		#f48fb1 50%, 
		#d81b60); /* å“çº¢è‰² */
	background-size: 300% 100%;
	animation: gradientAnimation 3s ease infinite;
}
.rainbow {
	background: linear-gradient(45deg, 
		#ff0000, #ff9900, #ffff00, #33ff00,
		#0099ff, #6633ff);
	background-size: 400% 400%;
	animation: rainbow 2.5s ease infinite;
}

@keyframes gradientAnimation {
	0% { background-position: 0% 50%; }
	50% { background-position: 100% 50%; }
	100% { background-position: 0% 50%; }
}

@keyframes rainbow {
	0% { background-position: 0% 50% }
	50% { background-position: 100% 50% }
	100% { background-position: 0% 50% }
}

.equipped { border: 2px solid #4CAF50; }

		
		#bossBar {
			height: 20px;
			background: #eee;
			border-radius: 10px;
			overflow: hidden;
			margin: 10px 0;
		}
		#bossHealth {
			height: 100%;
			background: #ff4444;
			transition: width 0.3s;
		}
		.boss-info {
			text-align: center;
			margin: 10px 0;
			font-size: 24px;
		}
		.auto-fighting { background: #FF5722; }
		.equipment-tabs {
			display: flex;
			gap: 10px;
			margin-bottom: 10px;
		}
		.tab-button {
			padding: 8px 15px;
			border-radius: 5px;
			background: #ddd;
			border: none;
		}
		.active-tab {
			background: #4CAF50;
			color: white;
		}
		
		/* æ–°å¢æ¦‚ç‡è¡¨æ ·å¼ */
.probability-table {
	background: #fff;
	border-radius: 8px;
	padding: 10px;
	margin-top: 10px;
	box-shadow: 0 2px 3px rgba(0,0,0,0.1);
}
.prob-row {
	display: flex;
	justify-content: space-between;
	padding: 6px 0;
	border-bottom: 1px solid #eee;
}
.prob-row.rare {
	color: #FF4081;
	font-weight: bold;
}
.prob-row span:first-child {
	color: #666;
}
.prob-row span:last-child {
	color: #2196F3;
}

.quest-panel {
			background: white;
			padding: 15px;
			border-radius: 10px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
			margin-top: 10px;
		}
		.quest-item {
			padding: 10px;
			margin: 8px 0;
			background: #f8f9fa;
			border-radius: 8px;
		}
		.progress-container {
			height: 12px;
			background: #e9ecef;
			border-radius: 6px;
			overflow: hidden;
			margin: 5px 0;
		}
		.progress-bar {
			height: 100%;
			background: #4CAF50;
			transition: width 0.3s ease;
		}
		.quest-header {
			display: flex;
			justify-content: space-between;
			margin-bottom: 5px;
		}
		.quest-level {
			color: #2196F3;
			font-weight: bold;
		}
		.quest-reward {
			font-size: 0.9em;
			color: #28a745;
		}
		
		
		.equip-confirm {
	position: fixed;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%);
	background: white;
	padding: 20px;
	border-radius: 10px;
	box-shadow: 0 0 10px rgba(0,0,0,0.2);
	z-index: 1000;
	text-align: center;
}
.confirm-buttons {
	margin-top: 15px;
	display: flex;
	gap: 10px;
}

.prob-row.ultra-rare {
  color: #FFD700;
  font-weight: bold;
  text-shadow: 0 0 5px rgba(255,215,0,0.5);
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

#autoCombineBtn {
  transition: all 0.3s ease;
}

#autoCombineBtn:active {
  transform: scale(0.95);
}

.auto-combining {
  animation: pulse 1.5s ease infinite;
  box-shadow: 0 0 15px rgba(96,125,139,0.5);
}
	</style>
</head>
<body>
	<div id="loginBox" class="login-box">
		<h2>æ³¨å†Œ/ç™»å½•</h2>
		<input type="text" id="username" placeholder="è´¦å·">
		<input type="password" id="password" placeholder="å¯†ç ">
		<input type="text" id="playerName" placeholder="è§’è‰²å">
		<div class="button-group">
			<button onclick="register()" style="background:#4CAF50">æ³¨å†Œ</button>
			<button onclick="login()" style="background:#2196F3">ç™»å½•</button>
		</div>
	</div>

	<!-- æ¸¸æˆä¸»ç•Œé¢ -->
	<div id="gameUI" class="hidden">
		<!-- çŠ¶æ€æ˜¾ç¤º -->
		<div class="status-box">
			<div>ğŸ‘¤<span id="showName">æ— å</span></div>
			<div>â¤ï¸è¡€é‡: <span id="hp">100</span>/<span id="maxHp">100</span></div>
			<div>ğŸ’é’»çŸ³: <span id="diamond">0</span></div>
			
<div>ğŸ‘‘ç­‰çº§: <span id="level">1</span> (ä¸‹çº§å¥–åŠ±: <span id="nextReward">100</span>ğŸ’)</div>
			<div>ğŸ“ˆç»éªŒ: <span id="exp">0<span id="needExp">100</span></div>
			<div>ğŸ”°å…³å¡: <span id="stage">1-1</span></div>
			<div>ğŸ—¡ï¸æ­¦å™¨: <span id="currentWeapon">æ— </span></div>
			<div>ğŸ›¡ï¸é˜²å¾¡: <span id="currentDefense">æ— </span></div>
		</div>
		
		<!-- BOSSæˆ˜ç•Œé¢ -->
	<div class="status-box">
		<h3>ğŸ¤ºBOSSæˆ˜</h3>
		<div class="boss-info" style="position: relative;">
			<div id="bossEmoji">ğŸ¤ª</div>
			<div>Lv.<span id="bossLevel">1</span> BOSS</div>
			<div id="bossHp">100/100</div>
			<div>ğŸ—¡ï¸æ”»å‡»åŠ›: <span id="bossAttack">5</span></div>  <!-- æ–°å¢æ”»å‡»åŠ›æ˜¾ç¤º -->
			<div>ğŸ†å‡»è´¥å¥–åŠ±: <span id="bossReward">ç»éªŒ50 + ç –çŸ³10 </span></div>
		</div>
		<div id="bossBar">
			<div id="bossHealth" style="width: 100%"></div>
		</div>
		<div class="button-group">
			<button onclick="attackBoss()" style="background:#F44336">ğŸ—¡ï¸æ”»å‡»BOSS</button>
			<button id="autoBtn" onclick="toggleAutoFight()" style="background:#9C27B0">âš¡è‡ªåŠ¨æˆ˜æ–—</button>
		</div>
	</div>
	
	<div class="quest-panel">
			<h3>ğŸ† æˆå°±ä»»åŠ¡</h3>
			<div id="questList"></div>
		</div>
		
		<!-- å•†åŸç•Œé¢ -->
	<div class="status-box">
		<div class="equipment-tabs">
			<button class="tab-button active-tab" onclick="showShopTab('weapon')">ğŸ—¡ï¸æ­¦å™¨å•†åŸ</button>
			<button class="tab-button" onclick="showShopTab('defense')">ğŸ›¡ï¸é˜²å¾¡å•†åŸ</button>
		</div>
		
		<!-- åœ¨æ­¦å™¨å•†åŸéƒ¨åˆ†æ–°å¢æ¦‚ç‡è¡¨ -->
<div id="weaponShop" class="shop-tab">
	<div class="button-group">
	<button onclick="drawWeapon(1)" style="background:#FF9800">å•è¿ (200ğŸ’)</button>
		<button onclick="drawWeapon(10)" style="background:#FF5722">åè¿ (2000ğŸ’)</button>
		<button onclick="drawWeapon(100)" style="background:#E91E63">ç™¾è¿ (20000ğŸ’)</button>
	<button onclick="drawWeapon(1000)" style="background:#673AB7">åƒè¿ (200000ğŸ’)</button>
</div>
	
	
	<!-- æ–°å¢æ¦‚ç‡è¡¨ -->
	<div class="probability-table">
	<div class="prob-row"><span>ğŸ—¡ï¸Lv.1</span><span>50%</span></div>
	<div class="prob-row"><span>âš”ï¸Lv.2</span><span>30%</span></div>
	<div class="prob-row"><span>ğŸLv.3</span><span>12%</span></div>
	<div class="prob-row"><span>ğŸŒ‚Lv.4</span><span>5%</span></div>
	<div class="prob-row"><span>ğŸ¡Lv.5</span><span>1.9%</span></div>
	<div class="prob-row"><span>ğŸ¯Lv.6</span><span>0.5%</span></div>
	<div class="prob-row"><span>ğŸ”«Lv.7</span><span>0.3%</span></div>
	<div class="prob-row"><span>ğŸ’£Lv.8</span><span>0.2%</span></div>
	<div class="prob-row"><span>ğŸ¹Lv.9</span><span>0.08%</span></div>
	<div class="prob-row rare"><span>ğŸ­Lv.10</span><span>0.01%</span></div>
	<div class="prob-row rare"><span>ğŸ‘‘Lv.11-15</span><span>0.005%æ¯çº§</span></div>
	<div class="prob-row rare"><span>ğŸ‘‘Lv.16-20</span><span>0.003%æ¯çº§</span></div>
	<div class="prob-row rare"><span>ğŸ‘‘Lv.21-25</span><span>0.0012%æ¯çº§</span></div>
	<div class="prob-row rare"><span>ğŸ‘‘Lv.26-30</span><span>0.0005%æ¯çº§</span></div>
	<div class="prob-row rare"><span>ğŸ‘‘Lv.31-35</span><span>0.00015%æ¯çº§</span></div>
	<div class="prob-row rare"><span>ğŸ‘‘Lv.36-40</span><span>0.00009%æ¯çº§</span></div>
	<div class="prob-row rare"><span>ğŸ‘‘Lv.41-45</span><span>0.00005%æ¯çº§</span></div>
	<div class="prob-row ultra-rare"><span>ğŸ‘‘Lv.46-50</span><span>0.00001%æ¯çº§</span></div>
  </div>
  </div>
  
<!-- åœ¨é˜²å¾¡å•†åŸéƒ¨åˆ†æ–°å¢æ¦‚ç‡è¡¨ -->
<div id="defenseShop" class="shop-tab" style="display:none">
	<div class="button-group">
		<button onclick="drawDefense(1)" style="background:#FF9800">å•æŠ½ (150ğŸ’)</button>
		<button onclick="drawDefense(10)" style="background:#FF5722">åè¿ (1500ğŸ’)</button>
	<button onclick="drawDefense(100)" style="background:#E91E63">ç™¾è¿ (15000ğŸ’)</button>
<button onclick="drawDefense(1000)" style="background:#673AB7">åƒè¿ (150000ğŸ’)</button>
</div>


	<div class="probability-table">
	<div class="prob-row"><span>ğŸ›¡ï¸Lv.1</span><span>50%</span></div>
	<div class="prob-row"><span>ğŸ”°Lv.2</span><span>30%</span></div>
	<div class="prob-row"><span>ğŸª˜Lv.3</span><span>12%</span></div>
	<div class="prob-row"><span>â›±ï¸Lv.4</span><span>5%</span></div>
	<div class="prob-row"><span>âšœï¸Lv.5</span><span>1.9%</span></div>
	<div class="prob-row"><span>ğŸ›¡ï¸Lv.6</span><span>0.5%</span></div>
	<div class="prob-row"><span>ğŸ”°Lv.7</span><span>0.3%</span></div>
	<div class="prob-row"><span>ğŸª˜Lv.8</span><span>0.2%</span></div>
	<div class="prob-row"><span>â›±ï¸Lv.9</span><span>0.08%</span></div>
	<div class="prob-row rare"><span>ğŸ”±Lv.10</span><span>0.01%</span></div>
	<div class="prob-row rare"><span>ğŸ‘‘Lv.11-15</span><span>0.005%æ¯çº§</span></div>
	<div class="prob-row rare"><span>ğŸ‘‘Lv.16-20</span><span>0.003%æ¯çº§</span></div>
	<div class="prob-row rare"><span>ğŸ‘‘Lv.21-25</span><span>0.0012%æ¯çº§</span></div>
	<div class="prob-row rare"><span>ğŸ‘‘Lv.26-30</span><span>0.0005%æ¯çº§</span></div>
	<div class="prob-row rare"><span>ğŸ‘‘Lv.31-35</span><span>0.00015%æ¯çº§</span></div>
	<div class="prob-row rare"><span>ğŸ‘‘Lv.36-40</span><span>0.00009%æ¯çº§</span></div>
	<div class="prob-row rare"><span>ğŸ‘‘Lv.41-45</span><span>0.00005%æ¯çº§</span></div>
	<div class="prob-row ultra-rare"><span>ğŸ‘‘Lv.46-50</span><span>0.00001%æ¯çº§</span></div>
</div>
</div>
		
	 <!-- èƒŒåŒ…ç•Œé¢ -->
	<div class="backpack">
			<div class="equipment-tabs">
				<button class="tab-button active-tab" onclick="showBackpackTab('weapon')">æ­¦å™¨èƒŒåŒ…</button>
				<button class="tab-button" onclick="showBackpackTab('defense')">é˜²å¾¡èƒŒåŒ…</button>
			</div>
			   <button onclick="combineEquipment()" style="background:#009688">âš™ï¸ä¸€é”®åˆæˆ</button>
		<button id="autoCombineBtn" onclick="toggleAutoCombine()" style="background:#607D8B">ğŸ¤–è‡ªåŠ¨åˆæˆ</button>
			<div id="equipmentList" style="margin-top: 10px;"></div>
		</div>
	</div>
	

  <!-- æç¤ºå®¹å™¨ -->
  <div id="messageBox" style="position: fixed; top: 20px; right: 20px; 
		 background: gold; padding: 10px; display: none;"></div>

<div id="confirmBox" class="equip-confirm hidden">
	<h4>ğŸ›¡ï¸ æ›´æ¢é˜²å¾¡è£…å¤‡</h4>
	<p id="confirmText"></p>
	<div class="confirm-buttons">
		<button onclick="confirmEquip(true)" style="background:#4CAF50">âœ… ç¡®è®¤</button>
		<button onclick="confirmEquip(false)" style="background:#F44336">âŒ å–æ¶ˆ</button>
	</div>
</div>

<div id="confirmBox" class="equip-confirm hidden">
	<h4>âš”ï¸ æ›´æ¢æ­¦å™¨</h4>
	<p id="confirmText"></p>
	<div class="confirm-buttons">
		<button onclick="confirmEquip(true)" style="background:#4CAF50">âœ… ç¡®è®¤</button>
		<button onclick="confirmEquip(false)" style="background:#F44336">âŒ å–æ¶ˆ</button>
	</div>
</div>

<script>

let autoCombineInterval = null;
let isCombining = false;

function showShopTab(type) {
	document.querySelectorAll('.shop-tab').forEach(tab => tab.style.display = 'none');
	document.getElementById(type + 'Shop').style.display = 'block';
	document.querySelectorAll('.shop .tab-button').forEach(btn => 
		btn.classList.remove('active-tab'));
	event.target.classList.add('active-tab');
}

function showBackpackTab(type) {
	document.querySelectorAll('.backpack .tab-button').forEach(btn => 
		btn.classList.remove('active-tab'));
	event.target.classList.add('active-tab');
	updateDisplay();
}

// æ•°å€¼æ ¼å¼åŒ–å‡½æ•°ï¼ˆæ–°å¢ï¼‰
function formatNumber(n) {
	const units = [
	{ threshold: 1e36, divisor: 1e36, unit: 'U' },
	{ threshold: 1e33, divisor: 1e33, unit: 'd' },
	{ threshold: 1e30, divisor: 1e30, unit: 'N' },
	{ threshold: 1e27, divisor: 1e27, unit: 'O' },
		{ threshold: 1e24, divisor: 1e24, unit: 'S' },
		{ threshold: 1e21, divisor: 1e21, unit: 's' },
		{ threshold: 1e18, divisor: 1e18, unit: 'Q' },
		{ threshold: 1e15, divisor: 1e15, unit: 'q' },
		{ threshold: 1e12, divisor: 1e12, unit: 'T' },
		{ threshold: 1e9, divisor: 1e9, unit: 'b' },
		{ threshold: 1e6, divisor: 1e6, unit: 'm' },
		{ threshold: 1e3, divisor: 1e3, unit: 'k' }
	];

	for (const unit of units) {
		if (n >= unit.threshold) {
			const value = n / unit.divisor;
			return value.toFixed(2)
					   .replace(/\.?0+$/, '') // å»é™¤æœ«å°¾çš„é›¶
					   .replace(/\.$/, '')	// å»é™¤å¤šä½™çš„å°æ•°ç‚¹
				+ unit.unit;
		}
	}
	return n.toString();
}
// ä¿®æ”¹åçš„åˆæˆåŠŸèƒ½
function combineEquipment() {
	const activeTab = document.querySelector('.backpack .active-tab').textContent;
	if(activeTab.includes("æ­¦å™¨")) {
		combineWeapons();
	} else {
		combineDefenses();
	}
}

let currentPage = 0;
const PAGE_SIZE = 50;

function showNextPage() {
  const start = currentPage * PAGE_SIZE;
  const end = start + PAGE_SIZE;
  const pageItems = gameData.weapons.slice(start, end);
  
  renderItems(pageItems);
  currentPage++;
}

function renderItems(items) {
  // ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨æŠ€æœ¯åªæ¸²æŸ“å¯è§åŒºåŸŸ
}

// æ–°å¢é˜²å¾¡è£…å¤‡åˆæˆé€»è¾‘
function combineDefenses() {
	const counts = {};
	gameData.defenses.forEach(d => counts[d.level] = (counts[d.level] || 0) + 1);
	
	Object.keys(counts).sort((a,b) => a - b).forEach(lvl => {
		let count = Math.floor(counts[lvl] / 3);
		while(count-- > 0) {
			let removed = 0;
			gameData.defenses = gameData.defenses.filter(d => {
				if(d.level == lvl && removed < 3) {
					removed++;
					return false;
				}
				return true;
			});
			const newLevel = parseInt(lvl)+1;
			gameData.defenses.push({
				level: newLevel,
				defense: 100 * Math.pow(2, newLevel-1),
				color: getColor(newLevel)
			});
		}
	});
	updateDisplay();
	saveGame();
}

let gameData = {
	username: '',
	playerName: '',
	hp: 100,		 // å½“å‰è¡€é‡
	maxHp: 100,	   // æœ€å¤§è¡€é‡ï¼ˆç”±é˜²å¾¡è£…å¤‡å†³å®šï¼‰
	diamond: 0,	   // é’»çŸ³æ•°é‡
	level: 1,		 // ç©å®¶ç­‰çº§
	exp: 0,		   // å½“å‰ç»éªŒ
	needExp: 100,	 // å‡çº§æ‰€éœ€ç»éªŒ
	currentStage: 1,  // å½“å‰å…³å¡
	bossCount: 0,	 // å½“å‰å…³å¡å‡»è´¥BOSSæ•°é‡
	weapons: [],	  // æ­¦å™¨åˆ—è¡¨
	defenses: [],	 // é˜²å¾¡è£…å¤‡åˆ—è¡¨
	currentWeapon: null,  // å½“å‰è£…å¤‡çš„æ­¦å™¨
	currentDefense: null,  // å½“å‰è£…å¤‡çš„é˜²å…·
	bossKills: {},	// æ–°å¢ï¼šBOSSå‡»æ€è®°å½•
	claimedQuests: {} // æ–°å¢ï¼šå·²é¢†å–ä»»åŠ¡
};

// ================= æˆ˜æ–—ç³»ç»Ÿå˜é‡ =================
let bossHealth = 0;			// BOSSå½“å‰è¡€é‡
let autoFightInterval = null;  // è‡ªåŠ¨æˆ˜æ–—è®¡æ—¶å™¨
const bossEmojis = ['ğŸ¤ªWerid Face','ğŸ‘¿Demon','ğŸ¤¡Joker','ğŸ‘»Gost','ğŸ‘¹Oni','ğŸ‘ºTengu','ğŸ¤–Robot','ğŸ’€Skull','â˜ ï¸King Skull','ğŸ‘½Alien ','ğŸƒPumpkin ','ğŸ¥·ğŸ»Ninja','ğŸ§Ÿâ€â™€ï¸Zombie','ğŸ‘ï¸Cyclops','ğŸ…Santa','ğŸ§â€â™‚ï¸Genie','ğŸ§œâ€â™€ï¸Mermaid','ğŸ‘¼Angel','ğŸª¼Jellyfish','ğŸ™Octopus','ğŸ§ŒTroll','ğŸ’©Pile of Poo','ğŸª°Fly','ğŸ«‘Pepper','ğŸ¥‘Avocado ','ğŸ«€Heart','ğŸ§ Brain','ğŸ§›â€â™€ï¸Vampire','ğŸ¦–T-rex','ğŸ²Dragon','ğŸ‰Draon King']; // BOSSè¡¨æƒ…é›†åˆ

// ================= ç”¨æˆ·ç³»ç»Ÿ =================
function register() {
	const username = document.getElementById('username').value;
	const password = document.getElementById('password').value;
	const playerName = document.getElementById('playerName').value;
	
	if(!username || !password || !playerName) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
	
	const users = JSON.parse(localStorage.getItem('users') || '{}');
	if(users[username]) return alert('è´¦å·å·²å­˜åœ¨');
	
	users[username] = { password, playerName };
	localStorage.setItem('users', JSON.stringify(users));
	
	// åˆå§‹åŒ–æ‰€æœ‰æ•°æ®
	gameData = {
		username,
		playerName,
		hp: 100,
		maxHp: 100,
		diamond: 0,
		level: 1,
		exp: 0,
		needExp: 100,
		currentStage: 1,
		bossCount: 0,
		weapons: [createWeapon(1)],
		defenses: [createDefense(1)],
		currentWeapon: null,
		currentDefense: null,
		bossKills: {},
		claimedQuests: {}
	};
	gameData.currentWeapon = gameData.weapons[0];
	gameData.currentDefense = gameData.defenses[0];
	gameData.hp = gameData.maxHp = gameData.defenses[0].defense;
	
	alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
}

function login() {
	const username = document.getElementById('username').value;
	const password = document.getElementById('password').value;
	const users = JSON.parse(localStorage.getItem('users') || '{}');
	
	if(!users[username] || users[username].password !== password) {
		return alert('è´¦å·æˆ–å¯†ç é”™è¯¯');
	}
	
	const savedData = localStorage.getItem(`gameData_${username}`);
	if(savedData) {
		const loadedData = JSON.parse(savedData);
		Object.assign(gameData, loadedData);
		// å…¼å®¹æ—§å­˜æ¡£
		if(!gameData.bossKills) gameData.bossKills = {};
		if(!gameData.claimedQuests) gameData.claimedQuests = {};
		gameData.playerName = users[username].playerName;
		gameData.username = username;
		updateMaxHp();
	} else {
		gameData.playerName = users[username].playerName;
		gameData.username = username;
		gameData.weapons = [createWeapon(1)];
		gameData.defenses = [createDefense(1)];
		gameData.currentWeapon = gameData.weapons[0];
		gameData.currentDefense = gameData.defenses[0];
		gameData.hp = gameData.maxHp = gameData.defenses[0].defense;
		gameData.bossKills = {};
		gameData.claimedQuests = {};
	}
	
	document.getElementById('loginBox').classList.add('hidden');
	document.getElementById('gameUI').classList.remove('hidden');
	initializeBoss();
	updateDisplay();
}
// ================= è£…å¤‡ç³»ç»Ÿ =================
// æ–°å¢ï¼šæ­¦å™¨æŠ½å¡
// ä¿®æ”¹åçš„æŠ½å¥–æ¦‚ç‡é€»è¾‘
// ä¿®æ”¹åçš„æ¦‚ç‡åˆ†å¸ƒé…ç½®
const probabilityConfig = [
  { level: 1, chance: 50.00 },   // 50%
  { level: 2, chance: 30.00 },   // 30%
  { level: 3, chance: 12.00 },   // 12%
  { level: 4, chance: 5.00 },	// 5%
  { level: 5, chance: 1.90 },	// 1.9%
  { level: 6, chance: 0.50 },	// 0.5%
  { level: 7, chance: 0.30 },	// 0.3%
  { level: 8, chance: 0.20 },	// 0.2%
  { level: 9, chance: 0.08 },	// 0.08%
  { level: 10, chance: 0.01 },   // 0.01%
  { level: 11, maxLevel: 15, chance: 0.005 },  // 11-15çº§ æ¯ç»„0.005%
  { level: 16, maxLevel: 20, chance: 0.002 },  // 16-20çº§ æ¯ç»„0.002%
  { level: 21, maxLevel: 25, chance: 0.0012 },  // 21-25çº§ æ¯ç»„0.0012%
  { level: 26, maxLevel: 30, chance: 0.0005 }, // 26-30çº§ æ¯ç»„0.0005%
  { level: 31, maxLevel: 35, chance: 0.00015 },// 31-35çº§ æ¯ç»„0.00015%
  { level: 36, maxLevel: 40, chance: 0.00009 },// 36-40çº§ æ¯ç»„0.00009%
  { level: 41, maxLevel: 45, chance: 0.00005 },// 41-45çº§ æ¯ç»„0.00005%
  { level: 46, maxLevel: 50, chance: 0.00001 } // 46-50çº§ æ¯ç»„0.00001%
];

// ä¿®æ”¹åçš„æŠ½å¥–é€»è¾‘
function getRandomLevel() {
  const rand = Math.random() * 100;
  let accumulated = 0;

  for (const config of probabilityConfig) {
	let chance = config.chance;
	let levels = 1;
	
	if (config.maxLevel) {
	  levels = config.maxLevel - config.level + 1;
	  chance = config.chance * levels;
	}

	if (rand <= accumulated + chance) {
	  if (config.maxLevel) {
		return Math.floor(config.level + Math.random() * levels);
	  }
	  return config.level;
	}
	accumulated += chance;
  }
  return 1; // ä¿åº•è¿”å›1çº§
}

// ä¿®æ”¹åçš„æ­¦å™¨æŠ½å¡å‡½æ•°
function drawWeapon(times) {
	let cost;
	if(times === 1) cost = 200;
	else if(times === 10) cost = 2000;
	else if(times === 100) cost = 20000;
	else if(times === 1000) cost = 200000;
	else return alert('æ— æ•ˆæ¬¡æ•°');
	
	if(gameData.diamond < cost) return alert('ğŸ’é’»çŸ³ä¸è¶³ï¼');
	
	gameData.diamond -= cost;
	const results = [];
	
	for(let i=0; i<times; i++){
		const level = getRandomLevel();
		results.push(level);
		gameData.weapons.push(createWeapon(level));
	}
	
	// ç»Ÿè®¡ç»“æœ
	const countMap = results.reduce((acc, lv) => {
		acc[lv] = (acc[lv] || 0) + 1;
		return acc;
	}, {});
	
	// ç”Ÿæˆç»“æœä¿¡æ¯
	let resultText = `è·å¾—è£…å¤‡ï¼ˆ${times}ä»¶ï¼‰ï¼š`;
	Object.keys(countMap).sort((a,b) => b-a).forEach(lv => {
		resultText += `\nLv${lv} x${countMap[lv]}`;
	});
	
	showMessage(resultText);
	saveGame();
	updateDisplay();
}

// ä¿®æ”¹åçš„drawDefenseå‡½æ•°
function drawDefense(times) {
	let cost;
	if(times === 1) cost = 150;
	else if(times === 10) cost = 1500;
	else if(times === 100) cost = 15000;
	else if(times === 1000) cost = 150000;
	else return alert('æ— æ•ˆæ¬¡æ•°');
	
	if(gameData.diamond < cost) return alert('ğŸ’é’»çŸ³ä¸è¶³ï¼');
	
	gameData.diamond -= cost;
	const results = [];
	
	for(let i=0; i<times; i++){
		const level = getRandomLevel();
		results.push(level);
		gameData.defenses.push(createDefense(level));
	}
	
	// ç»Ÿè®¡ç»“æœ
	const countMap = results.reduce((acc, lv) => {
		acc[lv] = (acc[lv] || 0) + 1;
		return acc;
	}, {});
	
	// ç”Ÿæˆç»“æœä¿¡æ¯
	let resultText = `è·å¾—è£…å¤‡ï¼ˆ${times}ä»¶ï¼‰ï¼š`;
	Object.keys(countMap).sort((a,b) => b-a).forEach(lv => {
		resultText += `\nLv${lv} x${countMap[lv]}`;
	});
	
	showMessage(resultText);
	saveGame();
	updateDisplay();
}

let pendingEquip = null; // å¾…æ›´æ¢çš„è£…å¤‡ä¿¡æ¯

// ä¿®æ”¹åçš„è£…å¤‡ç©¿æˆ´åŠŸèƒ½
function equipItem(level, type) {
	const items = type === 'weapon' ? gameData.weapons : gameData.defenses;
	const item = items.find(i => i.level === level);
	
	if(!item) return;
	if(type === 'weapon') {
		// æ­¦å™¨æ˜¾ç¤ºç¡®è®¤æ¡†
		const currentAttack = gameData.currentWeapon?.attack || 0;
		document.getElementById('confirmText').innerHTML = `
			<div style="color:#666">å½“å‰æ”»å‡»ï¼š${currentAttack}</div>
			<div style="color:#2196F3">æ›´æ¢åæ”»å‡»ï¼š${item.attack}</div>
			<div style="margin-top:8px;color:#ff5722">*æ›´æ¢å°†ç«‹å³ç”Ÿæ•ˆ</div>
		`;
		document.getElementById('confirmBox').classList.remove('hidden');
		pendingEquip = { item, type: 'weapon' };
	} else {
		// é˜²å¾¡è£…å¤‡æ˜¾ç¤ºç¡®è®¤
		const currentHp = gameData.hp;
		const newMaxHp = item.defense;
		const newHp = Math.min(currentHp, newMaxHp); // ç¡®ä¿ä¸è¶…è¿‡ä¸Šé™

document.getElementById('confirmText').innerHTML = `
			<div style="color:#666">å½“å‰è¡€é‡ï¼š${currentHp}/${gameData.maxHp}</div>
			<div style="color:#2196F3">æ›´æ¢åè¡€é‡ï¼š${newHp}/${newMaxHp}</div>
			<div style="margin-top:8px;color:#ff5722">*æ›´æ¢åå½“å‰è¡€é‡ä¿æŒä¸å˜</div>
		`;
		document.getElementById('confirmBox').classList.remove('hidden');
		pendingEquip = { item, newHp, newMaxHp };
	}
}

// ç¡®è®¤/å–æ¶ˆè£…å¤‡
function confirmEquip(isConfirm) {
	document.getElementById('confirmBox').classList.add('hidden');
	
	if(isConfirm && pendingEquip) {
		if(pendingEquip.type === 'weapon') {
			gameData.currentWeapon = pendingEquip.item;
		} else {
			gameData.currentDefense = pendingEquip.item;
			gameData.maxHp = pendingEquip.newMaxHp;
			gameData.hp = pendingEquip.newHp;
		}
		updateDisplay();
		saveGame();
	}
	pendingEquip = null;
}


// ================= æˆ˜æ–—ç³»ç»Ÿ =================
function initializeBoss() {
	const bossLevel = Math.ceil(gameData.currentStage / 10);
	bossHealth = 100 * Math.pow(2, bossLevel-1);
}

function attackBoss() {
  if(!gameData.currentWeapon) return alert('è¯·å…ˆè£…å¤‡æ­¦å™¨ï¼');
  
  const bossLevel = Math.ceil(gameData.currentStage / 10);
  const bossAttack = 5 * Math.pow(2, bossLevel-1);
  const playerAttack = gameData.currentWeapon.attack;

  // åˆ›å»ºä¼¤å®³æ•°å­—
  const damageNumber = document.createElement('div');
  damageNumber.className = 'damage-number';
  damageNumber.textContent = `-${formatNumber(playerAttack)}ğŸ©¸`;
  damageNumber.style.left = `${Math.random() * 50 + 25}%`;
  document.querySelector('.boss-info').appendChild(damageNumber);

  // æ·»åŠ è¡€æ¡æŠ–åŠ¨æ•ˆæœ
  const bossBar = document.getElementById('bossBar');
  bossBar.classList.add('shake');
  setTimeout(() => bossBar.classList.remove('shake'), 300);

  // æˆ˜æ–—è®¡ç®—
  let tempBossHp = bossHealth - playerAttack;
  let tempPlayerHp = gameData.hp;
  
  if(tempBossHp > 0) {
	tempPlayerHp = Math.max(tempPlayerHp - bossAttack, 0);
	// æ˜¾ç¤ºç©å®¶å—åˆ°çš„ä¼¤å®³
	showMessage(`ğŸ’” å—åˆ° ${formatNumber(bossAttack)} ç‚¹ä¼¤å®³ï¼`);
  }

  // æ›´æ–°è¡€æ¡åŠ¨ç”»
  const bossHealthBar = document.getElementById('bossHealth');
  bossHealthBar.style.transition = 'width 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
  
  // æ›´æ–°çŠ¶æ€
  bossHealth = Math.max(tempBossHp, 0);
  gameData.hp = tempPlayerHp;

  // ç«‹å³æ›´æ–°è¡€æ¡å®½åº¦ä»¥è§¦å‘åŠ¨ç”»
  const maxBossHp = 100 * Math.pow(2, bossLevel-1);
  const newWidth = (Math.max(bossHealth,0)/maxBossHp*100);
  bossHealthBar.style.width = `${newWidth}%`;

  // å…¶ä»–é€»è¾‘ä¿æŒä¸å˜...
  if(bossHealth <= 0) {
	const rewardBase = 50 * Math.pow(2, bossLevel-1);
	gameData.exp += rewardBase;
	gameData.diamond += bossLevel*10;
	gameData.bossCount++;
	
	// æ˜¾ç¤ºå‡»è´¥ç‰¹æ•ˆ
	const bossEmoji = document.getElementById('bossEmoji');
	bossEmoji.style.transform = 'scale(2)';
	bossEmoji.style.transition = 'transform 1s';
	setTimeout(() => bossEmoji.style.transform = 'scale(1)', 300);

if(Math.random() < 0.3) { // 30%æ‰è½å‡ ç‡
	const bossLevel = Math.ceil(gameData.currentStage / 10);
	const isWeapon = Math.random() < 0.5; // 50%å‡ ç‡æ­¦å™¨æˆ–é˜²å¾¡
	
	const dropNotice = document.createElement('div');
	dropNotice.className = 'drop-notice';
	dropNotice.innerHTML = isWeapon ? 
	  `ğŸ—¡ï¸ è·å¾— Lv${bossLevel} æ­¦å™¨!` : 
	  `ğŸ›¡ï¸ è·å¾— Lv${bossLevel} é˜²å¾¡è£…å¤‡!`;
	
	if(isWeapon) {
	  gameData.weapons.push(createWeapon(bossLevel));
	  dropNotice.style.color = "#2196F3"; // è“è‰²æ­¦å™¨æç¤º
	} else {
	  gameData.defenses.push(createDefense(bossLevel));
	  dropNotice.style.color = "#4CAF50"; // ç»¿è‰²é˜²å¾¡æç¤º
	}
	
	document.body.appendChild(dropNotice);
	setTimeout(() => dropNotice.remove(), 3000);
  }
	
	// æ›´æ–°ä»»åŠ¡ç³»ç»Ÿ
	gameData.bossKills[bossLevel] = (gameData.bossKills[bossLevel] || 0) + 1;
	processQuestRewards(bossLevel);
	
	if(gameData.bossCount >= 10) {
	  gameData.currentStage++;
	  gameData.bossCount = 0;
	}
	initializeBoss();
  }

  checkLevelUp();
  checkPlayerSurvival();
  saveGame();
  updateDisplay();
}

// ================= ä»»åŠ¡ç³»ç»Ÿ =================
function processQuestRewards(bossLevel) {
	const totalKills = gameData.bossKills[bossLevel];
	const claimed = gameData.claimedQuests[bossLevel] || 0;
	const availableClaims = Math.floor(totalKills / 10) - claimed;
	
	if(availableClaims > 0) {
		const baseReward = 1000 * Math.pow(2, bossLevel - 1);
		const expReward = baseReward * availableClaims;
		const diamondReward = baseReward * availableClaims;
		
		gameData.exp += expReward;
		gameData.diamond += diamondReward;
		gameData.claimedQuests[bossLevel] = (claimed + availableClaims);
		
		showMessage(`ğŸ‰ é¢†å– Lv${bossLevel} BOSSå¥–åŠ± x${availableClaims}æ¬¡\nè·å¾— ${expReward}ğŸ“ˆç»éªŒ + ${diamondReward}ğŸ’ç –çŸ³`);
	}
}

function updateQuestDisplay() {
	const container = document.getElementById('questList');
	container.innerHTML = '';
	
	const bossLevels = Object.keys(gameData.bossKills)
		.map(Number)
		.sort((a,b) => a - b);

	if(bossLevels.length === 0) {
		container.innerHTML = `<div style="text-align:center;color:#999">ğŸ¤ºå‡»è´¥ä»»æ„BOSSè§£é”é¦–ä¸ªä»»åŠ¡</div>`;
		return;
	}

	bossLevels.forEach(level => {
		const totalKills = gameData.bossKills[level];
		const claimed = gameData.claimedQuests[level] || 0;
		const progress = totalKills % 10;
		const progressPercent = (progress / 10) * 100;
		const nextReward = 1000 * Math.pow(2, level - 1);

		const questItem = document.createElement('div');
		questItem.className = 'quest-item';
		questItem.innerHTML = `
			<div class="quest-header">
				<span class="quest-level">Lv${level} BOSS</span>
				<span>ç´¯è®¡å‡»æ€ï¼š${totalKills}</span>
			</div>
			<div class="progress-container">
				<div class="progress-bar" style="width: ${progressPercent}%"></div>
			</div>
			<div class="quest-header">
				<span>è¿›åº¦ï¼š${progress}/10</span>
				<span class="quest-reward">å·²é¢†å– x${claimed}</span>
			</div>
			<div style="margin-top:5px; font-size:0.9em">
				'ä¸‹æ¬¡å¥–åŠ±ï¼š${formatNumber(nextReward)}ğŸ“ˆç»éªŒ + ${formatNumber(nextReward)}ğŸ’ç –çŸ³'
			</div>
		`;
		container.appendChild(questItem);
	});
}

// ================= åˆæˆç³»ç»Ÿ =================
function combineEquipment() {
	const activeTab = document.querySelector('.backpack .active-tab').textContent;
	if(activeTab === 'æ­¦å™¨èƒŒåŒ…') {
		combineWeapons();
	} else {
		combineDefenses();
	}
	
	let isCombining = false;

  if (isCombining) return;
  isCombining = true;
  // ...æ‰§è¡Œåˆæˆ...
  isCombining = false;
showMessage("ğŸ‰ åˆæˆå®Œæˆï¼");
}
function combineWeapons() {
  const levelMap = new Map();
  
  // é˜¶æ®µ1ï¼šç»Ÿè®¡ç­‰çº§åˆ†å¸ƒï¼ˆå•æ¬¡éå†ï¼‰
  gameData.weapons.forEach(weapon => {
	levelMap.set(weapon.level, (levelMap.get(weapon.level) || 0) + 1);
  });

  // é˜¶æ®µ2ï¼šæ‰¹é‡å¤„ç†åˆæˆ
  const newWeapons = [];
  const levels = [...levelMap.keys()].sort((a, b) => a - b);

  levels.forEach(level => {
	let count = levelMap.get(level);
	const canCombine = Math.floor(count / 3);
	
	if (canCombine > 0) {
	  // ä¿ç•™ä½™æ•°è£…å¤‡
	  const remaining = count % 3;
	  newWeapons.push(...Array(remaining).fill(level));
	  
	  // æ·»åŠ åˆæˆåçš„è£…å¤‡
	  newWeapons.push(...Array(canCombine).fill(level + 1));
	} else {
	  newWeapons.push(...Array(count).fill(level));
	}
  });

  // é˜¶æ®µ3ï¼šæ‰¹é‡æ›´æ–°æ•°æ®
  gameData.weapons = newWeapons.map(lv => createWeapon(lv));

	updateDisplay();
	saveGame();
}

function combineDefenses() {
const currentHp = gameData.hp; // ä¿å­˜å½“å‰è¡€é‡
	const counts = {};
	gameData.defenses.forEach(d => counts[d.level] = (counts[d.level] || 0) + 1);
	
	Object.keys(counts).sort((a,b) => a - b).forEach(lvl => {
		let count = Math.floor(counts[lvl] / 3);
		while(count-- > 0) {
			let removed = 0;
			gameData.defenses = gameData.defenses.filter(d => {
				if(d.level == lvl && removed < 3) {
					removed++;
					return false;
				}
				return true;
			});
			gameData.defenses.push(createDefense(parseInt(lvl)+1));
		}
	});
	gameData.hp = Math.min(currentHp, gameData.maxHp);
	updateDisplay();
	saveGame();
}

// ================= è¾…åŠ©å‡½æ•° =================
function createWeapon(level) {
	return {
		level: level,
		attack: 5 * Math.pow(2, level-1),
		color: getColor(level)
	};
}

function createDefense(level) {
	return {
		level: level,
		defense: 100 * Math.pow(2, level-1), // é˜²å¾¡å€¼å³æœ€å¤§è¡€é‡
		color: getColor(level)
	};
}

// ä¿®æ”¹åçš„é¢œè‰²åˆ†é…å‡½æ•°
function getColor(level) {
	if (level <= 5) return 'white';
	else if (level <= 10) return 'green';
	else if (level <= 15) return 'blue';
	else if (level <= 20) return 'yellow';
	else if (level <= 30) return 'purple';
	else if (level <= 40) return 'orange';
	else if (level <= 50) return 'red';
	else if (level <= 70) return 'pink';
	else return 'rainbow'; // 71çº§ä»¥ä¸Š
}
function updateMaxHp() {
	gameData.maxHp = gameData.currentDefense ? 
		gameData.currentDefense.defense : 0;
	gameData.hp = Math.min(gameData.hp, gameData.maxHp);
}

// ================= æ˜¾ç¤ºç³»ç»Ÿ =================
function updateDisplay() {
	// ç©å®¶çŠ¶æ€
	document.getElementById('showName').textContent = gameData.playerName;
	document.getElementById('hp').textContent = formatNumber(gameData.hp);
	document.getElementById('maxHp').textContent = formatNumber(gameData.maxHp);
	document.getElementById('diamond').textContent = formatNumber(gameData.diamond);
	document.getElementById('level').textContent = gameData.level;
	document.getElementById('exp').textContent = 
	`${formatNumber(gameData.exp)}/${formatNumber(gameData.needExp)}`;
	document.getElementById('stage').textContent = `${gameData.currentStage}-${gameData.bossCount+1}`;
	document.getElementById('currentWeapon').textContent = 
	gameData.currentWeapon ? `Lv.${gameData.currentWeapon.level} (${formatNumber(gameData.currentWeapon.attack)}æ”»)` : 'æ— ';	document.getElementById('currentDefense').textContent = 
	gameData.currentDefense ? `Lv.${gameData.currentDefense.level} (${formatNumber(gameData.currentDefense.defense)}è¡€)` : 'æ— ';

	// BOSSçŠ¶æ€
	const bossLevel = Math.ceil(gameData.currentStage / 10);
	const maxBossHp = 100 * Math.pow(2, bossLevel-1);

const bossAttack = 5 * Math.pow(2, bossLevel-1); // è®¡ç®—BOSSæ”»å‡»åŠ›

	document.getElementById('bossEmoji').textContent = 
		bossEmojis[Math.min(bossLevel-1, bossEmojis.length-1)] || 'ğŸ‘¾';
	document.getElementById('bossLevel').textContent = bossLevel;
	document.getElementById('bossHp').textContent = 
	`â¤ï¸${formatNumber(Math.max(bossHealth,0))}/${formatNumber(maxBossHp)}`;

document.getElementById('bossAttack').textContent = formatNumber(bossAttack);
	document.getElementById('bossReward').textContent = 
	`ğŸ“ˆ${formatNumber(50 * Math.pow(2, bossLevel-1))}ç»éªŒ + ğŸ’${formatNumber(10 * bossLevel)}é’»çŸ³`;
	document.getElementById('bossHealth').style.width = 
		`${(Math.max(bossHealth,0)/maxBossHp*100)}%`;

updateQuestDisplay(); // æ–°å¢ä»»åŠ¡æ˜¾ç¤º

  const nextReward = 100 * Math.pow(2, gameData.level - 1);
  document.getElementById('nextReward').textContent = formatNumber(nextReward);

	// è£…å¤‡åˆ—è¡¨
	const activeTab = document.querySelector('.backpack .active-tab').textContent;
	const type = activeTab.includes("æ­¦å™¨") ? 'weapon' : 'defense';
	const items = type === 'weapon' ? gameData.weapons : gameData.defenses;
	
	const container = document.getElementById('equipmentList');
	container.innerHTML = '';
	
	const counts = items.reduce((acc, item) => {
		acc[item.level] = (acc[item.level] || 0) + 1;
		return acc;
	}, {});

	Object.keys(counts).sort((a,b) => a - b).forEach(level => {
		const item = items.find(i => i.level == level);
		const div = document.createElement('div');
		div.className = `equipment-item ${item.color} ${
			(type === 'weapon' && gameData.currentWeapon?.level == level) ||
			(type === 'defense' && gameData.currentDefense?.level == level) ? 'equipped' : ''
		}`;

		div.innerHTML = `
			<div style="flex-grow:1">
				<div>Lv.${level} ${type === 'weapon' ? 'æ­¦å™¨' : 'é˜²å¾¡'}</div>
				<div style="font-size:12px;color:#666">
					${type === 'weapon' ? 
						`æ”»å‡»åŠ›: ${formatNumber(5 * Math.pow(2, level-1))}`:
`æœ€å¤§è¡€é‡: ${formatNumber(100 * Math.pow(2, level-1))}`}
				</div>
			</div>
			<div style="display:flex;align-items:center;gap:10px">
				<span style="font-weight:bold">Ã—${counts[level]}</span>
				<button onclick="equipItem(${level}, '${type}')" 
					style="background:#2196F3; padding:6px 12px; border-radius:4px; border:none; color:white">
					è£…å¤‡
				</button>
			</div>
		`;
		container.appendChild(div);
	});

	// è‡ªåŠ¨æˆ˜æ–—æŒ‰é’®çŠ¶æ€
	const autoBtn = document.getElementById('autoBtn');
	if(autoFightInterval) {
		autoBtn.textContent = 'ğŸ›‘åœæ­¢è‡ªåŠ¨';
		autoBtn.classList.add('auto-fighting');
	} else {
		autoBtn.textContent = 'âš¡è‡ªåŠ¨æˆ˜æ–—';
		autoBtn.classList.remove('auto-fighting');
	}
}

function toggleAutoCombine() {
	const btn = document.getElementById('autoCombineBtn');
	if (autoCombineInterval) {
		clearInterval(autoCombineInterval);
		autoCombineInterval = null;
		btn.style.background = '#607D8B';
		btn.innerHTML = 'ğŸ¤–è‡ªåŠ¨åˆæˆ';
		showMessage("è‡ªåŠ¨åˆæˆå·²åœæ­¢");
	} else {
		autoCombineInterval = setInterval(autoCombine, 500); // æ¯0.5ç§’æ‰§è¡Œä¸€æ¬¡
		btn.style.background = '#795548';
		btn.innerHTML = 'ğŸ›‘åœæ­¢è‡ªåŠ¨';
		showMessage("è‡ªåŠ¨åˆæˆå·²å¯åŠ¨ï¼ˆæ¯0.5ç§’æ£€æµ‹ï¼‰");
	}
}

// è‡ªåŠ¨åˆæˆé€»è¾‘
function autoCombine() {
	if (isCombining) return;
	isCombining = true;
	
	// è®°å½•åŸå§‹æ•°é‡ç”¨äºæ£€æµ‹å˜åŒ–
	const preWeaponCount = gameData.weapons.length;
	const preDefenseCount = gameData.defenses.length;
	
	// æ‰§è¡Œåˆæˆ
	combineWeapons();
	combineDefenses();
	
	// æ£€æµ‹æ˜¯å¦æœ‰å˜åŒ–
	if (gameData.weapons.length !== preWeaponCount || 
		gameData.defenses.length !== preDefenseCount) {
		showMessage("ğŸ¤–è‡ªåŠ¨åˆæˆå®Œæˆï¼");
	}
	
	isCombining = false;
}

// ================= å…¶ä»–ç³»ç»Ÿ =================


function showMessage(text) {
	  const box = document.getElementById("messageBox");
	  box.textContent = text;
	  box.style.display = "block";
	  setTimeout(() => box.style.display = "none", 5000);
	}


function checkLevelUp() {
	while (gameData.exp >= gameData.needExp) {
		const overflowExp = gameData.exp - gameData.needExp;
		const currentLevel = gameData.level; // è®°å½•å‡çº§å‰ç­‰çº§
		
		gameData.level++; // ç­‰çº§æå‡
		gameData.exp = overflowExp; // ä¿ç•™æº¢å‡ºç»éªŒ
		
		// é’»çŸ³å¥–åŠ± = 100 * 2^(æ–°ç­‰çº§-2)ï¼ˆæŒ‡æ•°çº§å¢é•¿ï¼‰
		const diamondReward = 100 * Math.pow(2, currentLevel - 1);
		gameData.diamond += diamondReward;
		
		showMessage(`å‡çº§åˆ° ${gameData.level} çº§ï¼è·å¾— ${diamondReward}ğŸ’`);
		
		// è®¾ç½®ä¸‹ä¸€çº§æ‰€éœ€ç»éªŒï¼ˆç¿»å€ï¼‰
		gameData.needExp *= 2; 
		
		// æ¯æ¬¡å‡çº§å›æ»¡è¡€
		gameData.hp = gameData.maxHp;
	}
}

function checkPlayerSurvival() {
	if (gameData.hp <= 0) {
		// é‡ç½®åˆ°å…³å¡1-BOSS1
		gameData.currentStage = 1;	// å¼ºåˆ¶å›åˆ°ç¬¬1å…³
		gameData.bossCount = 0;	   // é‡ç½®BOSSè¿›åº¦
		// ä¿ç•™é’»çŸ³ã€ç­‰çº§å’Œç»éªŒ
		gameData.hp = gameData.maxHp = gameData.currentDefense.defense; // å›æ»¡é˜²å¾¡è£…å¤‡æä¾›çš„è¡€é‡
		initializeBoss();			 // é‡æ–°åˆå§‹åŒ–BOSS
		alert('æˆ˜è´¥ï¼å…³å¡å°†é‡ç½®åˆ°1-1é‡æ–°å¼€å§‹ï¼');
		updateDisplay();
		saveGame();
	}
}

function toggleAutoFight() {
	const btn = document.getElementById('autoBtn');
	if (autoFightInterval) {
		clearInterval(autoFightInterval);
		autoFightInterval = null;
	} else {
		autoFightInterval = setInterval(() => {
			if (bossHealth > 0 && gameData.hp > 0) {
				attackBoss();
			} else {
				clearInterval(autoFightInterval);
				autoFightInterval = null;
			}
		}, 1000);
	}
	updateDisplay();
}


function saveGame() {
	const saveData = {
		username: gameData.username,
		playerName: gameData.playerName,
		hp: gameData.hp,
		maxHp: gameData.maxHp,
		diamond: gameData.diamond,
		level: gameData.level,
		exp: gameData.exp,
		needExp: gameData.needExp,
		currentStage: gameData.currentStage,
		bossCount: gameData.bossCount,
		weapons: gameData.weapons,
		defenses: gameData.defenses,
		currentWeapon: gameData.currentWeapon,
		currentDefense: gameData.currentDefense,
		bossKills: gameData.bossKills,
		claimedQuests: gameData.claimedQuests
	};
	localStorage.setItem(`gameData_${gameData.username}`, JSON.stringify(saveData));
}

// ================= åˆå§‹åŒ–æ¸¸æˆ =================
function initializeGame() {
	const savedUsers = localStorage.getItem('users');
	if(!savedUsers) {
		document.getElementById('loginBox').classList.remove('hidden');
	} else {
		document.getElementById('gameUI').classList.remove('hidden');
		initializeBoss();
		updateDisplay();
	}
}

// å¯åŠ¨æ¸¸æˆ
initializeGame();
</script>
</body>
</html>
